name: 'macOS: Cross-compile iOS libraries, copy to install dir & extend ldc2.conf'
inputs:
  arch:
    required: true
  ios_deployment_target:
    required: false
    default: '12.0'
runs:
  using: composite
  steps:
    - shell: bash
      run: |
        set -eux
        cd ..

        arch='${{ inputs.arch }}'
        deployment_target='${{ inputs.ios_deployment_target }}'
        triple="$arch-apple-ios$deployment_target${{ inputs.arch == 'x86_64' && '-simulator' || '' }}"
        if [[ "$arch" == arm64 ]]; then
            sysroot='/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk'
        else
            sysroot='/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneSimulator.platform/Developer/SDKs/iPhoneSimulator.sdk'
        fi

        install/bin/ldc-build-runtime --ninja \
          --dFlags="-mtriple=$triple" \
          --ldcSrcDir="$PWD/ldc" \
          --installWithSuffix="-ios-$arch" \
          RT_CONF_TRIPLE_REGEX="$arch-apple-ios" \
          CMAKE_SYSTEM_NAME=iOS \
          CMAKE_OSX_SYSROOT="$sysroot" \
          CMAKE_OSX_ARCHITECTURES="$arch" \
          CMAKE_OSX_DEPLOYMENT_TARGET="$deployment_target" \
          BUILD_LTO_LIBS=ON

        # append cross-compile flags to generated .conf file
        sed -i "" "s|^{\$|{\n    switches ~= [\n        \"-Xcc=-isysroot\",\n        \"-Xcc=${sysroot}\",\n    ];|" install/etc/ldc2.conf/55-target-ios-$arch.conf
        cat install/etc/ldc2.conf/*
